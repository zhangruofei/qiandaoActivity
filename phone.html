<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¿å®‰å†œå•†é“¶è¡Œ - ç­¾åˆ°æœ‰ç¤¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
        }

        /* ç­¾åˆ°å¡ç‰‡ */
        .checkin-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 350px;
            width: 100%;
            margin-bottom: 20px;
            transform: translateY(0);
            transition: all 0.3s ease;
        }

        .checkin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .checkin-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #667eea;
        }

        .checkin-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .checkin-desc {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* äºŒç»´ç æ‰«æåŒºåŸŸ */
        .qr-scanner {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 350px;
            width: 100%;
            text-align: center;
        }

        .qr-scanner.active {
            display: block;
        }

        #qr-video {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .qr-tips {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* çº¢åŒ…å¼¹çª— */
        .redpack-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .redpack-modal.show {
            display: flex;
        }

        .redpack-content {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border-radius: 20px;
            padding: 40px 30px;
            text-align: center;
            color: white;
            max-width: 300px;
            width: 90%;
            position: relative;
            animation: redpackShow 0.5s ease-out;
        }

        @keyframes redpackShow {
            from {
                opacity: 0;
                transform: scale(0.5) rotate(-10deg);
            }

            to {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .redpack-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .redpack-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .redpack-message {
            font-size: 1rem;
            margin-bottom: 25px;
            opacity: 0.9;
        }

        .redpack-close {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .redpack-close:hover {
            background: white;
            color: #ff6b6b;
        }

        /* çŠ¶æ€æç¤º */
        .status-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1rem;
            z-index: 999;
            display: none;
        }

        .status-message.show {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {

            0%,
            100% {
                opacity: 0;
            }

            50% {
                opacity: 1;
            }
        }

        /* ç­¾åˆ°æˆåŠŸçŠ¶æ€ */
        .success-state {
            display: none;
        }

        .success-state.show {
            display: block;
        }

        .success-icon {
            font-size: 4rem;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .success-title {
            font-size: 1.5rem;
            color: #4CAF50;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .success-desc {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* åº•éƒ¨ä¿¡æ¯ */
        .footer {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            text-align: center;
            color: white;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .checkin-card {
                padding: 25px 20px;
                margin: 0 10px 20px;
            }

            .checkin-icon {
                font-size: 3rem;
            }

            .checkin-title {
                font-size: 1.3rem;
            }
        }
    </style>
</head>

<body>
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ¦ è¿å®‰å†œå•†é“¶è¡Œ</h1>
        <p>ç­¾åˆ°æœ‰ç¤¼ï¼Œéªé©¬å¥”è…¾</p>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="main-content">
        <!-- ç­¾åˆ°å¡ç‰‡ -->
        <div class="checkin-card" id="checkinCard">
            <div class="checkin-icon">ğŸ“±</div>
            <div class="checkin-title">æ‰«ç ç­¾åˆ°</div>
            <div class="checkin-desc">æ‰«æäºŒç»´ç å®Œæˆç­¾åˆ°ï¼Œè·å¾—ä¸“å±çº¢åŒ…å¥–åŠ±ï¼Œé‡Šæ”¾æ‚¨çš„ç”µå­éªé©¬ï¼</div>
            <button class="btn" id="startScanBtn">å¼€å§‹æ‰«ç ç­¾åˆ°</button>
            <button class="btn" id="manualCheckinBtn"
                style="background: linear-gradient(45deg, #28a745, #20c997);">æ‰‹åŠ¨ç­¾åˆ°ï¼ˆæµ‹è¯•ï¼‰</button>
        </div>

        <!-- äºŒç»´ç æ‰«æåŒºåŸŸ -->
        <div class="qr-scanner" id="qrScanner">
            <video id="qr-video" autoplay muted playsinline></video>
            <div class="qr-tips">è¯·å°†äºŒç»´ç å¯¹å‡†æ‘„åƒå¤´æ‰«æ</div>
            <button class="btn" id="stopScanBtn"
                style="background: linear-gradient(45deg, #dc3545, #c82333);">åœæ­¢æ‰«æ</button>
        </div>

        <!-- ç­¾åˆ°æˆåŠŸçŠ¶æ€ -->
        <div class="checkin-card success-state" id="successState">
            <div class="success-icon">âœ…</div>
            <div class="success-title">ç­¾åˆ°æˆåŠŸï¼</div>
            <div class="success-desc">æ‚¨çš„ä¸“å±éªé©¬å·²åœ¨å¤§å±ä¸Šå¥”è…¾ï¼Œçº¢åŒ…å¥–åŠ±å·²å‘æ”¾ï¼</div>
            <button class="btn" id="resetBtn">é‡æ–°ç­¾åˆ°</button>
        </div>
    </div>

    <!-- çº¢åŒ…å¼¹çª— -->
    <div class="redpack-modal" id="redpackModal">
        <div class="redpack-content">
            <div class="redpack-icon">ğŸ§§</div>
            <div class="redpack-amount" id="redpackAmount">Â¥0.00</div>
            <div class="redpack-message">æ­å–œè·å¾—ç­¾åˆ°çº¢åŒ…ï¼</div>
            <button class="redpack-close" id="redpackClose">é¢†å–çº¢åŒ…</button>
        </div>
    </div>

    <!-- çŠ¶æ€æç¤º -->
    <div class="status-message" id="statusMessage"></div>

    <!-- åº•éƒ¨ -->
    <div class="footer">
        <p>Â© 2024 è¿å®‰å†œå•†é“¶è¡Œ ç‰ˆæƒæ‰€æœ‰</p>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="config.js"></script>
    <script src="client-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <script>
        class PhoneApp {
            constructor() {
                this.socket = null;
                this.isScanning = false;
                this.stream = null;
                this.userId = this.generateUserId();
                this.userName = this.generateUserName();
                this.isCheckedIn = false;

                this.init();
            }

            init() {
                this.bindEvents();
                this.connectSocket();
            }

            // ç”Ÿæˆç”¨æˆ·ID
            generateUserId() {
                return 'user_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            }

            // ç”Ÿæˆç”¨æˆ·å
            generateUserName() {
                const names = ['å¼ ä¸‰', 'æå››', 'ç‹äº”', 'èµµå…­', 'é’±ä¸ƒ', 'å­™å…«', 'å‘¨ä¹', 'å´å'];
                return names[Math.floor(Math.random() * names.length)] + Math.floor(Math.random() * 100);
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                document.getElementById('startScanBtn').addEventListener('click', () => {
                    this.startQRScan();
                });

                document.getElementById('stopScanBtn').addEventListener('click', () => {
                    this.stopQRScan();
                });

                document.getElementById('manualCheckinBtn').addEventListener('click', () => {
                    this.manualCheckin();
                });

                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetApp();
                });

                document.getElementById('redpackClose').addEventListener('click', () => {
                    this.closeRedpack();
                });
            }

            // è¿æ¥SocketæœåŠ¡å™¨
            connectSocket() {
                try {
                    // ä½¿ç”¨åŠ¨æ€é…ç½®è¿æ¥Socket.io
                    const socketConfig = getSocketConfig();
                    this.socket = io(socketConfig.url, socketConfig.options);

                    this.socket.on('connect', () => {
                        console.log('æ‰‹æœºç«¯è¿æ¥æˆåŠŸ');
                        this.socket.emit('join-room', 'phone');
                    });

                    this.socket.on('checkin-success', (data) => {
                        this.handleCheckinSuccess(data);
                    });

                    this.socket.on('disconnect', () => {
                        console.log('æ‰‹æœºç«¯è¿æ¥æ–­å¼€');
                    });
                } catch (error) {
                    console.log('Socketè¿æ¥å¤±è´¥ï¼Œä½¿ç”¨ç¦»çº¿æ¨¡å¼');
                }
            }

            // å¼€å§‹äºŒç»´ç æ‰«æ
            async startQRScan() {
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment'
                        }
                    });

                    const video = document.getElementById('qr-video');
                    video.srcObject = this.stream;

                    document.getElementById('checkinCard').style.display = 'none';
                    document.getElementById('qrScanner').classList.add('active');

                    this.isScanning = true;
                    this.scanQRCode();

                } catch (error) {
                    console.error('æ‘„åƒå¤´è®¿é—®å¤±è´¥:', error);
                    this.showMessage('æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            }

            // åœæ­¢äºŒç»´ç æ‰«æ
            stopQRScan() {
                this.isScanning = false;

                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }

                document.getElementById('qrScanner').classList.remove('active');
                document.getElementById('checkinCard').style.display = 'block';
            }

            // æ‰«æäºŒç»´ç 
            scanQRCode() {
                if (!this.isScanning) return;

                const video = document.getElementById('qr-video');
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.height = video.videoHeight;
                    canvas.width = video.videoWidth;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);

                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);

                    if (window.jsQR) {
                        const code = jsQR(imageData.data, imageData.width, imageData.height);

                        if (code) {
                            console.log('æ‰«æåˆ°äºŒç»´ç :', code.data);
                            this.processQRCode(code.data);
                            return;
                        }
                    }
                }

                requestAnimationFrame(() => this.scanQRCode());
            }

            // å¤„ç†äºŒç»´ç æ•°æ®
            processQRCode(qrData) {
                this.stopQRScan();

                // è¿™é‡Œå¯ä»¥éªŒè¯äºŒç»´ç æ•°æ®
                if (qrData.includes('checkin') || qrData.includes('ç­¾åˆ°')) {
                    this.performCheckin();
                } else {
                    this.showMessage('æ— æ•ˆçš„ç­¾åˆ°äºŒç»´ç ');
                    setTimeout(() => {
                        document.getElementById('checkinCard').style.display = 'block';
                    }, 2000);
                }
            }

            // æ‰‹åŠ¨ç­¾åˆ°ï¼ˆæµ‹è¯•ç”¨ï¼‰
            manualCheckin() {
                if (this.isCheckedIn) {
                    this.showMessage('æ‚¨å·²ç»ç­¾åˆ°è¿‡äº†');
                    return;
                }
                this.performCheckin();
            }

            // æ‰§è¡Œç­¾åˆ°
            performCheckin() {
                if (this.isCheckedIn) {
                    this.showMessage('æ‚¨å·²ç»ç­¾åˆ°è¿‡äº†');
                    return;
                }

                this.showMessage('æ­£åœ¨ç­¾åˆ°...');

                const checkinData = {
                    userId: this.userId,
                    userName: this.userName,
                    timestamp: Date.now(),
                    location: 'è¿å®‰å†œå•†é“¶è¡Œæ´»åŠ¨ç°åœº'
                };

                // å‘é€ç­¾åˆ°æ•°æ®åˆ°æœåŠ¡å™¨
                if (this.socket && this.socket.connected) {
                    this.socket.emit('user-checkin', checkinData);
                } else {
                    // ç¦»çº¿æ¨¡å¼ï¼Œç›´æ¥å¤„ç†ç­¾åˆ°æˆåŠŸ
                    setTimeout(() => {
                        this.handleCheckinSuccess({
                            ...checkinData,
                            redpackAmount: this.generateRedpackAmount()
                        });
                    }, 1500);
                }
            }

            // å¤„ç†ç­¾åˆ°æˆåŠŸ
            handleCheckinSuccess(data) {
                this.isCheckedIn = true;

                // éšè—ç­¾åˆ°å¡ç‰‡ï¼Œæ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                document.getElementById('checkinCard').style.display = 'none';
                document.getElementById('successState').classList.add('show');

                // æ˜¾ç¤ºçº¢åŒ…
                setTimeout(() => {
                    this.showRedpack(data.redpackAmount || this.generateRedpackAmount());
                }, 1000);
            }

            // ç”Ÿæˆéšæœºçº¢åŒ…é‡‘é¢
            generateRedpackAmount() {
                const amounts = [0.88, 1.88, 2.88, 5.88, 8.88, 10.88, 18.88, 28.88];
                return amounts[Math.floor(Math.random() * amounts.length)];
            }

            // æ˜¾ç¤ºçº¢åŒ…
            showRedpack(amount) {
                document.getElementById('redpackAmount').textContent = `Â¥${amount.toFixed(2)}`;
                document.getElementById('redpackModal').classList.add('show');

                // æ’­æ”¾çº¢åŒ…éŸ³æ•ˆï¼ˆå¦‚æœæœ‰ï¼‰
                this.playSound('redpack');
            }

            // å…³é—­çº¢åŒ…
            closeRedpack() {
                document.getElementById('redpackModal').classList.remove('show');
                this.showMessage('çº¢åŒ…å·²å‘æ”¾åˆ°æ‚¨çš„è´¦æˆ·ï¼');
            }

            // é‡ç½®åº”ç”¨
            resetApp() {
                this.isCheckedIn = false;
                this.userId = this.generateUserId();
                this.userName = this.generateUserName();

                document.getElementById('successState').classList.remove('show');
                document.getElementById('checkinCard').style.display = 'block';
                document.getElementById('redpackModal').classList.remove('show');
            }

            // æ˜¾ç¤ºæ¶ˆæ¯
            showMessage(message) {
                const messageEl = document.getElementById('statusMessage');
                messageEl.textContent = message;
                messageEl.classList.add('show');

                setTimeout(() => {
                    messageEl.classList.remove('show');
                }, 2000);
            }

            // æ’­æ”¾éŸ³æ•ˆ
            playSound(type) {
                try {
                    const audio = new Audio();
                    if (type === 'redpack') {
                        // çº¢åŒ…éŸ³æ•ˆçš„base64æ•°æ®æˆ–URL
                        audio.src =
                            'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT';
                    }
                    audio.volume = 0.3;
                    audio.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', e));
                } catch (error) {
                    console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥:', error);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new PhoneApp();
        });

        // é˜²æ­¢é¡µé¢ç¼©æ”¾
        document.addEventListener('touchstart', function (event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>

</html>